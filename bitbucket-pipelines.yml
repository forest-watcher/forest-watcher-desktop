pipelines:
  definitions:
    - step: &build
        name: Build
        image: node:16.14.0
        deployment: test
        caches:
          - node
        artifacts:
          - build/**
        script:
          - yarn install
          - yarn test
          - yarn build
    - step: &deploy_test
        name: Deploy to develop
        trigger: manual
        image: atlassian/pipelines-awscli
        artifacts:
          - build/**
        script:
          - cd build
          - aws s3 sync . s3://forest-watcher-web-client-dev
          - aws cloudfront create-invalidation --distribution-id E3I4LK8QQA91ZN --paths "/*"
    - step: &deploy_staging
        name: Deploy to staging
        trigger: manual
        image: atlassian/pipelines-awscli
        artifacts:
          - build/**
        script:
          - cd build
          - aws s3 sync . s3://forest-watcher-web-client-staging
          - aws cloudfront create-invalidation --distribution-id E3UEJWTVPP1UFQ --paths "/*"
  pull-requests:
    '**':
      - step: *build
  branches:
    develop:
      - step: *build
      - step: *deploy_test
    master:
      - step:
          <<: *build
          deployment: staging
      - step: *deploy_staging
